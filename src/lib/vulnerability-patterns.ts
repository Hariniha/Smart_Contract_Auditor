// Vulnerability Detection Patterns

import { VulnerabilityPattern } from '@/types';

export const VULNERABILITY_PATTERNS: VulnerabilityPattern[] = [
  // Reentrancy (SWC-107)
  {
    pattern: /\.call\{value:\s*\w+\}|\.call\.value\(|\.send\(|\.transfer\(/,
    swcId: 'SWC-107',
    name: 'Potential Reentrancy',
    severity: 'Critical',
    description: 'External call detected that may be vulnerable to reentrancy attacks',
    check: (code: string) => {
      // Check for external calls before state changes
      const hasExternalCall = /\.call\{value:|\.send\(|\.transfer\(/.test(code);
      const hasStateChange = /=\s*\w+|\.push\(|\.pop\(/.test(code);
      return hasExternalCall && hasStateChange;
    }
  },

  // Unprotected Ether Withdrawal (SWC-105)
  {
    pattern: /function\s+withdraw.*public|function\s+withdrawAll.*public/i,
    swcId: 'SWC-105',
    name: 'Unprotected Ether Withdrawal',
    severity: 'Critical',
    description: 'Withdrawal function may lack proper access controls',
    check: (code: string) => {
      const hasWithdraw = /function\s+\w*withdraw\w*/i.test(code);
      const hasModifier = /onlyOwner|require\(.*==.*msg\.sender/.test(code);
      return hasWithdraw && !hasModifier;
    }
  },

  // Unprotected SELFDESTRUCT (SWC-106)
  {
    pattern: /selfdestruct\(/i,
    swcId: 'SWC-106',
    name: 'Unprotected SELFDESTRUCT',
    severity: 'Critical',
    description: 'selfdestruct instruction may be callable by anyone',
    check: (code: string) => {
      const hasSelfDestruct = /selfdestruct\(/i.test(code);
      const hasProtection = /onlyOwner|require\(.*msg\.sender/.test(code);
      return hasSelfDestruct && !hasProtection;
    }
  },

  // Delegatecall to Untrusted Callee (SWC-112)
  {
    pattern: /\.delegatecall\(/i,
    swcId: 'SWC-112',
    name: 'Delegatecall to Untrusted Callee',
    severity: 'Critical',
    description: 'delegatecall usage may allow arbitrary code execution',
    check: (code: string) => /\.delegatecall\(/i.test(code)
  },

  // Integer Overflow/Underflow (SWC-101)
  {
    pattern: /\+\+|--|\+=|-=|\*=|\/=/,
    swcId: 'SWC-101',
    name: 'Potential Integer Overflow/Underflow',
    severity: 'Critical',
    description: 'Arithmetic operation without overflow protection detected',
    check: (code: string) => {
      const hasArithmetic = /\+\+|--|\s*\+\s*|\s*-\s*|\s*\*\s*/.test(code);
      const hasSafeMath = /SafeMath|using\s+SafeMath|pragma solidity \^0\.[8-9]|pragma solidity \^[1-9]/.test(code);
      return hasArithmetic && !hasSafeMath;
    }
  },

  // Unchecked Call Return Value (SWC-104)
  {
    pattern: /\.call\(|\.delegatecall\(|\.send\(/,
    swcId: 'SWC-104',
    name: 'Unchecked Call Return Value',
    severity: 'High',
    description: 'Return value of external call is not checked',
    check: (code: string) => {
      const lines = code.split('\n');
      for (const line of lines) {
        if (/\.call\(|\.send\(/.test(line) && !line.includes('require') && !line.includes('if')) {
          return true;
        }
      }
      return false;
    }
  },

  // tx.origin Authentication (SWC-115)
  {
    pattern: /tx\.origin/,
    swcId: 'SWC-115',
    name: 'Authorization through tx.origin',
    severity: 'High',
    description: 'tx.origin used for authorization is vulnerable to phishing attacks',
    check: (code: string) => /tx\.origin/.test(code)
  },

  // Block Timestamp Manipulation (SWC-116)
  {
    pattern: /block\.timestamp|now\s/,
    swcId: 'SWC-116',
    name: 'Block Timestamp Dependency',
    severity: 'Medium',
    description: 'Use of block.timestamp can be influenced by miners',
    check: (code: string) => /block\.timestamp|now\s/.test(code)
  },

  // Weak Randomness (SWC-120)
  {
    pattern: /block\.timestamp|block\.difficulty|block\.number.*random|blockhash/i,
    swcId: 'SWC-120',
    name: 'Weak Source of Randomness',
    severity: 'High',
    description: 'Randomness source can be predicted or manipulated',
    check: (code: string) => {
      const hasRandom = /random/i.test(code);
      const usesBlockData = /block\.(timestamp|difficulty|number|blockhash)/.test(code);
      return hasRandom && usesBlockData;
    }
  },

  // Function Default Visibility (SWC-100)
  {
    pattern: /function\s+\w+\s*\([^)]*\)\s*(?!public|private|internal|external)/,
    swcId: 'SWC-100',
    name: 'Function Default Visibility',
    severity: 'High',
    description: 'Function visibility not explicitly declared',
    check: (code: string) => {
      const functionMatches = code.match(/function\s+\w+\s*\([^)]*\)\s*/g);
      if (!functionMatches) return false;
      
      for (const match of functionMatches) {
        if (!/public|private|internal|external/.test(match)) {
          return true;
        }
      }
      return false;
    }
  },

  // State Variable Default Visibility (SWC-108)
  {
    pattern: /^\s*(uint|int|bool|address|string|bytes)\s+\w+\s*[;=]/m,
    swcId: 'SWC-108',
    name: 'State Variable Default Visibility',
    severity: 'Medium',
    description: 'State variable visibility not explicitly declared',
    check: (code: string) => {
      const varMatches = code.match(/^\s*(uint|int|bool|address|string|bytes)\s+\w+\s*[;=]/gm);
      if (!varMatches) return false;
      
      for (const match of varMatches) {
        if (!/public|private|internal/.test(match)) {
          return true;
        }
      }
      return false;
    }
  },

  // Floating Pragma (SWC-103)
  {
    pattern: /pragma\s+solidity\s+\^/,
    swcId: 'SWC-103',
    name: 'Floating Pragma',
    severity: 'Low',
    description: 'Floating pragma allows compilation with multiple versions',
    check: (code: string) => /pragma\s+solidity\s+\^/.test(code)
  },

  // Outdated Compiler Version (SWC-102)
  {
    pattern: /pragma\s+solidity/,
    swcId: 'SWC-102',
    name: 'Outdated Compiler Version',
    severity: 'Medium',
    description: 'Consider using a more recent compiler version',
    check: (code: string) => {
      const match = code.match(/pragma\s+solidity\s+.*?([0-9]+)\.([0-9]+)\.([0-9]+)/);
      if (!match) return false;
      const major = parseInt(match[1]);
      const minor = parseInt(match[2]);
      return major === 0 && minor < 8;
    }
  },

  // Uninitialized Storage Pointer (SWC-109)
  {
    pattern: /^\s*\w+\[\]\s+\w+\s*;/m,
    swcId: 'SWC-109',
    name: 'Uninitialized Storage Pointer',
    severity: 'High',
    description: 'Uninitialized storage variable detected',
    check: (code: string) => {
      return /^\s*\w+\[\]\s+\w+\s*;/m.test(code);
    }
  },

  // DoS with Block Gas Limit (SWC-128)
  {
    pattern: /for\s*\([^)]*\)\s*\{[^}]*\.push\(/,
    swcId: 'SWC-128',
    name: 'DoS with Block Gas Limit',
    severity: 'High',
    description: 'Unbounded loop that modifies storage may hit gas limit',
    check: (code: string) => {
      return /for\s*\([^)]*\)\s*\{/.test(code) && /\.push\(|\.pop\(/.test(code);
    }
  },

  // Transaction Order Dependence (SWC-114)
  {
    pattern: /approve\s*\(/,
    swcId: 'SWC-114',
    name: 'Transaction Order Dependence',
    severity: 'High',
    description: 'Function may be vulnerable to front-running attacks',
    check: (code: string) => /function\s+approve\s*\(/.test(code)
  },

  // Deprecated Functions (SWC-111)
  {
    pattern: /suicide\(|throw\b|sha3\(|block\.blockhash/,
    swcId: 'SWC-111',
    name: 'Use of Deprecated Functions',
    severity: 'Low',
    description: 'Deprecated Solidity functions should not be used',
    check: (code: string) => /suicide\(|throw\b|sha3\(|block\.blockhash/.test(code)
  },

  // Signature Malleability (SWC-117)
  {
    pattern: /ecrecover\(/,
    swcId: 'SWC-117',
    name: 'Signature Malleability',
    severity: 'Medium',
    description: 'ecrecover may be vulnerable to signature malleability',
    check: (code: string) => /ecrecover\(/.test(code)
  },

  // Missing Replay Protection (SWC-121)
  {
    pattern: /ecrecover\(/,
    swcId: 'SWC-121',
    name: 'Missing Signature Replay Protection',
    severity: 'High',
    description: 'Signature verification may lack replay protection',
    check: (code: string) => {
      const hasEcrecover = /ecrecover\(/.test(code);
      const hasNonce = /nonce/.test(code);
      return hasEcrecover && !hasNonce;
    }
  },

  // Hash Collision (SWC-133)
  {
    pattern: /abi\.encodePacked\(/,
    swcId: 'SWC-133',
    name: 'Hash Collision with Variable Length Arguments',
    severity: 'High',
    description: 'abi.encodePacked with multiple variable length arguments may cause collisions',
    check: (code: string) => /abi\.encodePacked\(.*,.*\[/.test(code)
  },

  // Message Call with Hardcoded Gas (SWC-134)
  {
    pattern: /\.call\{gas:\s*\d+\}/,
    swcId: 'SWC-134',
    name: 'Message Call with Hardcoded Gas',
    severity: 'Medium',
    description: 'Hardcoded gas amount may cause issues in future hard forks',
    check: (code: string) => /\.call\{gas:\s*\d+\}/.test(code)
  },

  // Unencrypted Private Data (SWC-136)
  {
    pattern: /private\s+(uint|int|address|string|bytes).*password|private.*secret|private.*key/i,
    swcId: 'SWC-136',
    name: 'Unencrypted Private Data On-Chain',
    severity: 'High',
    description: 'Private variables are visible on blockchain',
    check: (code: string) => /private\s+.*?(password|secret|key|private)/i.test(code)
  }
];

export function getPatternBySWC(swcId: string): VulnerabilityPattern | undefined {
  return VULNERABILITY_PATTERNS.find(p => p.swcId === swcId);
}

export function getPatternsBySeverity(severity: string): VulnerabilityPattern[] {
  return VULNERABILITY_PATTERNS.filter(p => p.severity === severity);
}
